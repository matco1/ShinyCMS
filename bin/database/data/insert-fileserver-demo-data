#!/usr/bin/env perl

# ===================================================================
# File:		bin/database/insert-fileserver-demo-data
# Project:	ShinyCMS
# Purpose:	Insert fileserver demo data via DBIC
# 
# Author:	Denny de la Haye <2019@denny.me>
# Copyright (c) 2009-2019 Denny de la Haye
# 
# ShinyCMS is free software; you can redistribute it and/or modify it
# under the terms of either the GPL 2.0 or the Artistic License 2.0
# ===================================================================

use strict;
use warnings;

# Local modules
use FindBin qw( $Bin );
use lib "$Bin/../../../lib";
use ShinyCMS;
use ShinyCMS::Schema;


# Find out what year it is
my $year = DateTime->now->year;
my $next = $year + 1;
my $prev = $year - 1;

# Get a database connection
my $schema = ShinyCMS::Schema->connect(
	ShinyCMS->config->{ 'Model::DB' }->{ connect_info }
);

# Create a user, give them access to restricted files
my $user = $schema->resultset( 'User' )->find_or_create({
	username    => 'viewer',
	password    => 'changeme',
	email       => 'viewer@example.com',
	admin_notes => 'Part of the fileserver demo data.',
});
my $access1 = $schema->resultset( 'Access' )->find_or_create({
	access => 'Eternal',
});
my $access2 = $schema->resultset( 'Access' )->find_or_create({
	access => 'Expired',
});
my $access3 = $schema->resultset( 'Access' )->find_or_create({
	access => 'Unexpired',
});
my $access4 = $schema->resultset( 'Access' )->find_or_create({
	access => 'Exclusive',
});
$user->user_accesses->find_or_create({
	access  => $access1->id,
});
$user->user_accesses->find_or_create({
	access  => $access2->id,
	expires => $prev . '-12-31 12:34:56'
});
$user->user_accesses->find_or_create({
	access  => $access3->id,
	expires => $next . '-12-31 12:34:56'
});

# Create a couple of access log entries
$user->file_accesses->create({
	access_group => 'Eternal',
	filepath     => 'dir-one',
	filename     => 'empty-file.txt',
	ip_address   => '10.10.10.10',
});
$user->file_accesses->create({
	access_group => 'Unexpired',
	filepath     => 'sub/sub/sub/dir',
	filename     => 'empty-too.txt',
	ip_address   => '10.20.30.40',
});
