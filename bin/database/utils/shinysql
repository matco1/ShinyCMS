#!/usr/bin/env perl

# ===================================================================
# File:		bin/database/shinysql
# Project:	ShinyCMS
# Purpose:	Connect to database using details from shinycms.conf
# 
# Author:	Denny de la Haye <2019@denny.me>
# Copyright (c) 2009-2019 Denny de la Haye
# 
# ShinyCMS is free software; you can redistribute it and/or modify it
# under the terms of either the GPL 2.0 or the Artistic License 2.0
# ===================================================================

use strict;
use warnings;

# CPAN modules
use Config::General;
use FindBin qw( $Bin );

# Get the database details
my $env = '';
$env = '_test' if $ENV{ SHINYCMS_TEST };
my $config_file = $Bin . "/../../../config/shinycms${env}.conf";
my $reader = Config::General->new( $config_file );
my %config = $reader->getall;
my $connect_info = $config{ 'Model::DB' }->{ connect_info };

# Extract the useful bits
my $username = $connect_info->{ user };
my $password = $connect_info->{ password };
my $database;
my $hostname;
if ( $connect_info->{ dsn } =~ m/database=/ ) {
    $connect_info->{ dsn } =~ m/:database=(\w+);host=([\d\.]+)$/;
    $database = $1;
    $hostname = $2;
}
else {
    $connect_info->{ dsn } =~ m/:(\w+)$/;
    $database = $1;
}

# Issue the mysql command
my $command = "mysql --user=$username --password=$password ";
$command .= "--host=$hostname " if $hostname;
$command .= " $database";
system $command;
